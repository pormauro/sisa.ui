# Contexto de membresías corporativas

El `CompanyMembershipsContext` consolida los estados `pending`, `invited`, `approved`, `rejected`, `cancelled`, `left`, `removed` y `suspended`, así como los metadatos asociados al puesto, fechas laborales, visibilidad y notas internas que definen la relación entre usuario y empresa.【F:contexts/CompanyMembershipsContext.tsx†L15-L173】Los historiales guardan el tipo de operación, notas, razones, usuario ejecutor y un `metadata_snapshot` parseado cuando la API expone el bloque como JSON o cadena serializada.【F:contexts/CompanyMembershipsContext.tsx†L338-L452】Todo se persiste en memoria mediante `useCachedState` para cada empresa y filtro (`approved`, `pending`, `all`, etc.), reutilizando la misma caché al consultar nuevamente.【F:contexts/CompanyMembershipsContext.tsx†L477-L641】

La normalización ahora reconoce las claves en español `empresa_id`, `usuario_id`, `rol` y `estado`, además de los nuevos datos de usuario (`user_full_name`, `username`, `user_email`) cuando vienen embebidos en la respuesta de `/companies/{id}/memberships`, por lo que los administradores incluidos en el listado se muestran con su rol y datos de contacto sin requerir cambios en el backend.【F:contexts/CompanyMembershipsContext.tsx†L187-L359】

## Permisos y visibilidad
El contexto cruza los permisos provenientes de `PermissionsContext` con banderas derivadas como `canManageMemberships`, `canInviteMembers`, `canLeaveCompany` o `canViewHistory`, por lo que los componentes sólo necesitan leer estas propiedades antes de mostrar acciones sensibles.【F:contexts/CompanyMembershipsContext.tsx†L489-L555】Además, los métodos de lectura devuelven inmediatamente lo último cacheado cuando el usuario carece del permiso (`loadMemberships`/`loadMembershipHistory`) evitando peticiones innecesarias.【F:contexts/CompanyMembershipsContext.tsx†L557-L709】
La API usa `listCompanyMembers`/`listUserCompanyMemberships` para habilitar listados, `inviteCompanyMembers` y `cancelCompanyInvitations` para administrar invitaciones, `reactivateCompanyMember` para reactivar o aprobar y `manageCompanyMemberships` para rechazos, suspensiones, bajas y auditorías, por lo que el contexto se apoya en esas claves al calcular cada bandera.【F:contexts/CompanyMembershipsContext.tsx†L489-L555】【F:app/permission/PermissionScreen.tsx†L20-L38】

## Operaciones expuestas
- `loadMemberships(companyId, status)` arma la URL con `status` (incluido `all`), ejecuta `GET /companies/{id}/memberships` con token Bearer y ordena el resultado por las marcas temporales `created_at`/`updated_at`.【F:contexts/CompanyMembershipsContext.tsx†L614-L642】
- `loadMembershipHistory(companyId, membershipId)` llama a `GET /companies/{id}/memberships/{membershipId}/history`, normaliza y ordena el timeline para alimentar los modales de auditoría.【F:contexts/CompanyMembershipsContext.tsx†L670-L709】
- `handleMembershipMutation` centraliza el uso del token Bearer, el chequeo de `ensureAuthResponse`, la limpieza de cachés por empresa y la invalidación del historial de la membresía afectada antes de devolver un booleano.【F:contexts/CompanyMembershipsContext.tsx†L711-L752】
- `requestMembership`, `inviteMember`, `acceptInvitation`, `cancelInvitation`, `approveMembership`, `rejectMembership`, `leaveMembership`, `suspendMember` y `removeMember` reutilizan ese helper y sólo se habilitan cuando los permisos correspondientes están activos, evitando que la interfaz intente operaciones que el backend bloquearía.【F:contexts/CompanyMembershipsContext.tsx†L754-L912】

## Flujos en la app (v1.3.8)
- Desde `app/companies/memberships.tsx` los usuarios pueden solicitar ser **administradores** o **miembros** mediante un modal que envía `POST /companies/{id}/memberships` con rol sugerido, mensaje, departamento y cargo, reutilizando la bandera `canRequestMembership` del contexto.【F:app/companies/memberships.tsx†L36-L395】【F:app/companies/memberships.tsx†L480-L555】
- Las invitaciones ahora se pueden **aceptar** con el token recibido, y cualquier miembro con permisos puede **abandonar** la empresa; ambos casos limpian la caché y refrescan el listado tras completar el flujo.【F:app/companies/memberships.tsx†L440-L555】【F:app/companies/memberships.tsx†L754-L870】
- Los administradores habilitados ven botones para **aprobar**, **rechazar**, **suspender**, **remover** o **cancelar invitaciones** según el estado (`pending`, `approved`, `suspended`, `invited`), disparando los endpoints correspondientes antes de refrescar el listado.【F:app/companies/memberships.tsx†L494-L578】【F:app/companies/memberships.tsx†L576-L665】
- Se incorporó un modal de **historial** para auditar cada membresía (`GET /companies/{id}/memberships/{membershipId}/history`) cuando `canViewHistory` está activo, mostrando operación, estados, usuario responsable, notas y metadata serializada.【F:app/companies/memberships.tsx†L792-L870】
- La versión publicada que sincroniza esta guía es la `1.3.8` definida en `config/Index.ts`, por lo que la documentación y la app mantienen sincronía de funcionalidades y permisos.【F:config/Index.ts†L1-L3】
- El release 1.3.8 documentado en `sisa.api` (config/version.json) mantiene las mismas notas de membresías corporativas y cacheo de historial, por lo que los flujos descritos aquí se conservan alineados entre backend y UI.

## Colección de Postman y variables
La colección `docs/postman/sisa-api.postman_collection.json` incorpora la carpeta "Company Memberships" con ejemplos listos para listar por estado, solicitar acceso, invitar, aceptar, cancelar, aprobar, rechazar, abandonar, suspender, remover y consultar historiales bajo el encabezado Bearer documentado globalmente.【F:docs/postman/sisa-api.postman_collection.json†L2300-L2688】También se añadieron las variables `company_id`, `membership_id`, `invited_user_id` y `membership_token` para facilitar la reutilización de IDs y tokens en los ejemplos interactivos.【F:docs/postman/sisa-api.postman_collection.json†L2693-L2717】

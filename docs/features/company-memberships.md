# Membresías de empresas

Este módulo enlaza a los usuarios con las empresas que administran o necesitan consultar. A partir de esta iteración se normalizó el estado de cada solicitud y se extendieron los formularios para capturar los campos que espera la API `sisa.api`.

## Estados normalizados
- Los estados permitidos ahora son `pending`, `approved` y `rejected`. Cada valor incluye metadatos (etiqueta localizada, descripción y paleta de colores) en `constants/companyMemberships.ts` y se expone mediante el contexto `CompanyMembershipsContext` para reutilizarlo en formularios y listados.【F:constants/companyMemberships.ts†L1-L104】【F:contexts/CompanyMembershipsContext.tsx†L24-L115】
- Todas las pantallas que muestran estados utilizan la misma normalización y un `MembershipStatusBadge` que aplica los colores y etiquetas correspondientes.【F:components/MembershipStatusBadge.tsx†L1-L53】

## Campos adicionales en los formularios
- Las vistas de creación y edición incorporan selectores para estados/roles y controles de texto para `message` (motivo de la solicitud) y `reason` (respuesta al aprobar o rechazar). Se envían normalizados mediante `normalizeNullableText` antes de invocar la API.【F:app/company_memberships/create.tsx†L23-L187】【F:app/company_memberships/[id].tsx†L23-L208】
- Los listados y modales muestran los mensajes y motivos capturados para que los administradores puedan priorizar y auditar cada solicitud.【F:app/company_memberships/index.tsx†L1-L240】【F:app/company_memberships/viewModal.tsx†L1-L120】

## Listado con filtros por estado
- El listado principal ahora permite filtrar y ordenar por estado normalizado utilizando los catálogos del contexto. También se sumaron chips con el mensaje y la respuesta para cada registro.【F:app/company_memberships/index.tsx†L1-L240】

## Vistas rápidas, filtros persistentes y KPIs compartibles
- La pantalla de listados persiste automáticamente la última combinación de búsqueda, estado y orden utilizando AsyncStorage. El helper `filterStorage.ts` maneja la serialización bajo las llaves `companyMemberships:lastFilters` y `companyMemberships:savedViews`, mientras que `filterTypes.ts` centraliza los tipos permitidos para sort y estado.【F:app/company_memberships/filterStorage.ts†L1-L86】【F:app/company_memberships/filterTypes.ts†L1-L11】
- Desde la misma UI se pueden crear “vistas guardadas” tocando el botón **Guardar actual**, nombrando la combinación y luego reutilizándola como chip. Cada vista incluye acciones para copiar la configuración en JSON (para compartirla por chat o Postman) y eliminarla cuando deje de ser relevante.【F:app/company_memberships/index.tsx†L254-L366】【F:app/company_memberships/index.tsx†L512-L580】
- Las “vistas rápidas” calculan automáticamente escenarios de seguimiento (pendientes mayores a 7 días y top de empresas con más solicitudes) de modo que cualquier administrador pueda aplicar filtros operativos con un solo toque.【F:app/company_memberships/index.tsx†L211-L250】【F:app/company_memberships/index.tsx†L418-L471】
- Encima del listado se añadieron KPIs por estado y rol que se recalculan en tiempo real conforme cambian los filtros, lo cual permite compartir las cifras exactas en los canales internos sin tener que exportar datos adicionales.【F:app/company_memberships/index.tsx†L252-L311】【F:app/company_memberships/index.tsx†L378-L417】

## Panel táctico dentro de la ficha de empresas
- La vista de empresas incorpora un panel compuesto bajo "Accesos y membresías" con chips por rol/estado, KPIs históricos (última solicitud atendida, promedio de respuesta y relación entre pendientes/activos) y botones rápidos para abrir la ficha de cada miembro sin abandonar el modal.【F:app/companies/viewModal.tsx†L521-L655】
- En el mismo bloque se agregó un timeline ordenado por `updated_at` que muestra insignias de estado, mensajes y acciones rápidas de aprobación/rechazo. Esto evita cambiar de pantalla cuando se procesan solicitudes urgentes y mantiene el historial visible para todo el equipo.【F:app/companies/viewModal.tsx†L657-L741】

## Recordatorio de seguridad
- Todas las operaciones continúan enviando el token `Bearer` provisto por `AuthContext`; el backend sigue sin claves foráneas, por lo que la normalización ocurre en el cliente antes de persistir los datos.【F:contexts/CompanyMembershipsContext.tsx†L410-L520】【F:docs/setup-and-configuration.md†L16-L26】
- Aun cuando los endpoints expongan rutas anidadas (`/companies/{companyId}/memberships/...`), el payload mantiene los campos `company_id` y `user_id` explícitos porque la base `sisa.api` carece de restricciones `FOREIGN KEY`. Esto permite que las instalaciones antiguas puedan registrar auditorías completas incluso si siguen consumiendo los controladores legacy.【F:docs/features/modules.md†L82-L110】【F:contexts/CompanyMembershipsContext.tsx†L25-L188】

## Sincronización automática y alertas
- `CompanyMembershipsContext` expone el trío `lastSyncedAt`/`syncError`/`isStale` y una cola `notifications` con utilidades (`enqueueNotification`, `dismissNotification`, `clearNotifications`, `clearSyncError`) para que cada pantalla presente banners persistentes y permita limpiarlos de forma manual cuando el usuario ya leyó el mensaje.【F:contexts/CompanyMembershipsContext.tsx†L566-L678】【F:contexts/CompanyMembershipsContext.tsx†L1260-L1280】
- El efecto de sincronización ejecuta `loadCompanyMemberships()` al montar el provider y reprograma una nueva consulta cada cinco minutos. Si la instalación publica SSE/WS bajo `/company_memberships/stream`, se abre un canal en vivo que invoca `mergeMembershipIntoState` apenas llegan cambios remotos; si no existe, el temporizador mantiene la caché fresca igualmente.【F:contexts/CompanyMembershipsContext.tsx†L708-L898】
- `lastSyncedAt` facilita indicadores visuales (por ejemplo, mostrar “Actualizado hace 2 min” o pintar un banner rojo cuando `isStale` sea `true`). Tras atender la alerta, basta con llamar a `clearSyncError()` o `dismissNotification(id)` para ocultar el aviso sin esperar otro ciclo de sincronización.【F:contexts/CompanyMembershipsContext.tsx†L660-L678】【F:contexts/CompanyMembershipsContext.tsx†L1260-L1280】

## Flujo operativo detallado
1. **Solicitud**. Desde `app/company_memberships/request.tsx` cualquier usuario autenticado dispara `requestMembershipAccess` con `message`, `role`, `notes` y la empresa objetivo. El contexto detecta si existe el endpoint anidado y publica la solicitud dejando la membresía en `pending`.【F:app/company_memberships/request.tsx†L24-L212】【F:contexts/CompanyMembershipsContext.tsx†L600-L748】
2. **Revisión**. Los administradores usan el listado (`index.tsx`) o los formularios (`[id].tsx`) para consultar el detalle, verificar los mensajes y capturar observaciones adicionales antes de tomar una decisión. El estado normalizado guía los filtros y las insignias reutilizadas en todo el módulo.【F:app/company_memberships/index.tsx†L1-L240】【F:components/MembershipStatusBadge.tsx†L1-L53】
3. **Resolución**. Al aprobar o rechazar, `updateMembershipStatus` intenta primero los endpoints `/companies/{companyId}/memberships/{membershipId}/approve|reject`; si la instalación responde `404`, cae automáticamente en `PUT /company_memberships/{id}` preservando `reason`, `responded_at`, `responded_by_*` y `audit_flags`. Esta lógica mantiene el historial y alimenta el timeline que el backend expone vía `/history`.【F:contexts/CompanyMembershipsContext.tsx†L520-L918】
4. **Acciones posteriores**. El mismo flujo soporta suspensiones, bajas voluntarias, expulsiones y el consumo del historial completo para alinear la UI con los cambios realizados desde Postman u otras integraciones. Los catálogos y el parser centralizado garantizan que los formularios sigan mostrando mensajes/roles actualizados aunque el backend agregue nuevos campos opcionales.【F:contexts/CompanyMembershipsContext.tsx†L188-L344】

## Operaciones disponibles en la colección Postman
La colección `docs/postman/sisa-api.postman_collection.json` reúne cada operación relevante para probar las membresías end-to-end. Todas comparten autenticación Bearer (se omite únicamente en el login) y cada descripción recuerda que la base `sisa.api` no usa `FOREIGN KEY`.

- **List Company Memberships** — Permite navegar los miembros y solicitudes de una empresa filtrando por estado (`pending`, `invited`, `approved`, `rejected`, etc.) antes de tomar acciones desde la UI.【F:docs/postman/sisa-api.postman_collection.json†L2308-L2379】
- **Request Company Membership** — Emula el autoservicio del módulo capturando `message`, `role`, `notes`, `employment_type` y banderas como `visibility`; el script posterior guarda el `membership_id` para reutilizarlo en los flujos de aprobación/rechazo.【F:docs/postman/sisa-api.postman_collection.json†L2380-L2476】
- **Invite/Cancel/Accept** — Incluye `Invite Company Member`, `Cancel Company Invitation` y `Accept Company Invitation` para cubrir el ciclo completo de invitaciones manuales, con `expires_at`, `invitation_message` y validación del `invitation_token` que la app muestra cuando existen permisos administrativos.【F:docs/postman/sisa-api.postman_collection.json†L2477-L2605】
- **Approve/Reject Company Membership** — Registra la decisión y documenta `notes`, `reason`, `message` y el rol operativo; es el mismo payload que la UI envía cuando se resuelve una solicitud desde el listado o el detalle.【F:docs/postman/sisa-api.postman_collection.json†L2477-L2605】
- **Membership lifecycle actions** — Se agregaron `Leave Company Membership`, `Suspend Company Member`, `Remove Company Member` y `Get Membership History` para completar el set de operaciones soportadas por el backend. Cada request captura `notes` obligatorias para auditar la salida y mantiene sincronizadas las variables de la colección, lo cual facilita reproducir los escenarios que la UI muestra dentro del timeline de la membresía.【F:docs/postman/sisa-api.postman_collection.json†L2606-L2705】

> Nota: al utilizar la colección desde Postman o Newman se recomienda ejecutar primero el login y luego las operaciones en el orden descrito para hidratar las variables `membership_company_id`, `membership_user_id` y `membership_id`. Así se replica exactamente la secuencia que maneja `CompanyMembershipsContext` y se detectan regresiones antes de promover cambios al entorno productivo.【F:docs/postman/sisa-api.postman_collection.json†L2360-L2476】
